<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<meta name="theme-color" content="#2962ff"/>
<title>Espace Partenaire - AlexLivraison</title>
<link rel="manifest" href="manifest-partner.json">
<link rel="apple-touch-icon" href="icon.jpg">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  :root { 
    --primary: #2962ff; 
    --primary-gradient: linear-gradient(135deg, #2962ff 0%, #00bcd4 100%);
    --bg-gradient: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 50%, #9fa8da 100%);
    --text: #1a237e; 
    --card-bg: rgba(255, 255, 255, 0.96); 
    --shadow: 0 10px 30px rgba(0,0,0,0.08); 
    --glass-border: 1px solid rgba(255, 255, 255, 0.7);
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Segoe UI', 'Roboto', sans-serif; background: var(--bg-gradient); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; min-height: 100vh; }
  
  .bg-logos { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 0; pointer-events: none; }
  .floating-logo { position: absolute; width: 40px; height: 40px; border-radius: 50%; opacity: 0.08; animation: floatUp 25s linear infinite; object-fit: cover; filter: hue-rotate(180deg) grayscale(20%); mix-blend-mode: multiply; }
  .floating-logo:nth-child(1) { left: 10%; animation-duration: 20s; animation-delay: 0s; }
  .floating-logo:nth-child(2) { left: 80%; animation-duration: 28s; animation-delay: 2s; }
  .floating-logo:nth-child(3) { left: 40%; animation-duration: 22s; animation-delay: 5s; }
  .floating-logo:nth-child(4) { left: 20%; animation-duration: 25s; animation-delay: 8s; }
  .floating-logo:nth-child(5) { left: 60%; animation-duration: 30s; animation-delay: 1s; }
  @keyframes floatUp { 0% { transform: translateY(110vh) rotate(0deg); } 100% { transform: translateY(-10vh) rotate(360deg); } }

  .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-gradient); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
  .login-card { background: var(--card-bg); backdrop-filter: blur(15px); padding: 50px 35px; border-radius: 35px; text-align: center; border: var(--glass-border); box-shadow: 0 20px 60px rgba(0,0,0,0.1); width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; margin: 0 auto; position: relative; z-index: 2; transition: transform 0.3s; }
  .login-card:hover { transform: translateY(-5px); }
  
  .pin-input { font-size: 1.6em; letter-spacing: 10px; text-align: center; padding: 18px; border: 2px solid transparent; background: #f5f7fa; border-radius: 20px; width: 100%; margin: 30px 0 25px 0; outline: none; color: #333; transition: 0.3s; box-shadow: inset 0 2px 5px rgba(0,0,0,0.03); }
  .pin-input:focus { background: #fff; border-color: var(--primary); box-shadow: 0 5px 15px rgba(41, 98, 255, 0.15); }
  
  .btn { background: var(--primary-gradient); color: #fff; border: none; padding: 18px 24px; border-radius: 20px; font-weight: 700; cursor: pointer; font-size: 1.1em; box-shadow: 0 10px 20px rgba(41, 98, 255, 0.3); transition: all 0.2s ease; width: 100%; display: flex; align-items: center; justify-content: center; gap: 12px; }
  .btn:active { transform: scale(0.98); box-shadow: 0 5px 10px rgba(41, 98, 255, 0.2); }
  .btn:hover { filter: brightness(1.1); }

  .btn-install { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: #fff; border: none; padding: 18px 24px; border-radius: 20px; font-weight: 700; cursor: pointer; font-size: 1.1em; box-shadow: 0 10px 20px rgba(56, 239, 125, 0.3); transition: all 0.2s ease; width: 100%; display: none; align-items: center; justify-content: center; gap: 12px; margin-top: 20px; }
  .btn-install:active { transform: scale(0.98); box-shadow: 0 5px 10px rgba(56, 239, 125, 0.2); }
  .btn-install:hover { filter: brightness(1.1); transform: translateY(-2px); }
  
  @keyframes sticker-bounce { 0%, 100% { transform: translateY(0) rotate(0deg); } 25% { transform: translateY(-8px) rotate(-10deg); } 75% { transform: translateY(-5px) rotate(10deg); } }
  .sticker-anim { display: inline-block; animation: sticker-bounce 2s ease-in-out infinite; }

  .btn-outline { background: #fff; color: #555; border: 1px solid #e0e0e0; padding: 16px 24px; border-radius: 20px; font-weight: 700; cursor: pointer; font-size: 1em; transition: 0.2s; width: 100%; margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
  .btn-outline:hover { background: #f0f4f8; color: var(--primary); border-color: var(--primary); }
  .btn-outline:active { transform: scale(0.98); }
  
  .dashboard { display: none; padding: 20px; max-width: 1000px; margin: 0 auto; padding-bottom: 90px; padding-top: 100px; position: relative; z-index: 5; }
  
  .topbar { position: fixed; top: 0; left: 0; width: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); padding: 10px 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); z-index: 900; display: flex; align-items: center; justify-content: space-between; height: 80px; border-bottom: 1px solid rgba(255,255,255,0.3); }
  
  .hamburger { width: 45px; height: 45px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 6px; background: #fff; border-radius: 12px; cursor: pointer; border: 1px solid #eee; z-index: 910; transition: 0.2s; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
  .hamburger:active { transform: scale(0.95); }
  .hamburger span { width: 24px; height: 2.5px; background: #1a237e; border-radius: 3px; }
  
  .menu { position: fixed; top: 0; left: -100%; width: 320px; height: 100vh; background: #fff; padding: 30px; transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 2000; display: flex; flex-direction: column; box-shadow: 20px 0 50px rgba(0,0,0,0.1); }
  .menu.open { left: 0; }
  .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1500; display: none; backdrop-filter: blur(5px); }
  .menu-overlay.show { display: block; }
  
  .menu-header { display: flex; justify-content: flex-end; margin-bottom: 40px; }
  .close-btn { color: #333; font-size: 28px; background: #f5f5f5; border: none; cursor: pointer; padding: 8px 12px; border-radius: 50%; transition: 0.2s; }
  .close-btn:hover { background: #eee; }
  
  .menu-link { display: flex; align-items: center; gap: 18px; color: #455a64; text-decoration: none; padding: 20px; border-radius: 18px; font-weight: 600; transition: .2s; font-size: 16px; cursor: pointer; margin-bottom: 8px; border: 1px solid transparent; }
  .menu-link:hover { background: #e3f2fd; color: var(--primary); border-color: #bbdefb; }
  
  .lang-section { margin-top: auto; border-top: 1px solid #eee; padding-top: 20px; }
  
  .shop-info-header { position: absolute; left: 50%; transform: translateX(-50%); text-align: center; width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .shop-title { font-size: 1.4em; font-weight: 800; color: #1a237e; letter-spacing: -0.5px; }
  .shop-id { font-size: 0.85em; color: #90a4ae; margin-top: 3px; font-weight: 500; }

  @keyframes stickerFloat { 0% { transform: translateY(0); } 50% { transform: translateY(-4px); } 100% { transform: translateY(0); } }
  .emoji-anim { display: inline-block; animation: stickerFloat 2.5s ease-in-out infinite; }

  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; margin-bottom: 40px; }
  .stat-card { background: #fff; padding: 30px; border-radius: 25px; box-shadow: var(--shadow); text-align: center; border: var(--glass-border); transition: transform 0.3s; position: relative; overflow: hidden; }
  .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.12); }
  .stat-val { font-size: 2.2em; font-weight: 800; color: #333; margin: 15px 0 5px 0; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .stat-label { color: #78909c; font-size: 0.9em; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

  .live-section { margin-bottom: 40px; }
  .live-title { color: #1a237e; font-size: 1.8em; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; font-weight: 800; }
  
  .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 30px; }
  .order-card { background: #fff; border-radius: 25px; padding: 30px; box-shadow: var(--shadow); border: 1px solid #fff; position: relative; animation: slideIn 0.5s ease; transition: all 0.3s; }
  .order-card:hover { transform: translateY(-7px); box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
  @keyframes slideIn { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }
  
  .oc-new { border-left: 6px solid #2962ff; }
  .oc-cooking { border-left: 6px solid #00bcd4; }
  .oc-ready { border-left: 6px solid #00c853; }
  
  .oc-header { display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #f0f0f0; }
  .oc-id { font-weight: 800; color: #1a237e; font-size: 1em; background: #e3f2fd; padding: 6px 12px; border-radius: 10px; }
  .oc-time { font-size: 0.95em; color: #90a4ae; font-weight: 600; }
  .oc-client { font-weight: 800; font-size: 1.4em; margin-bottom: 8px; color: #263238; }
  .oc-phone { font-size: 1.05em; color: #546e7a; display: flex; align-items: center; gap: 8px; margin-bottom: 20px; background: #f5f7fa; padding: 8px 12px; border-radius: 12px; width: fit-content; }
  .oc-items { background: #f8f9fa; padding: 18px; border-radius: 18px; margin-bottom: 20px; max-height: 220px; overflow-y: auto; border: 1px solid #eee; }
  .oc-item { display: flex; justify-content: space-between; font-size: 1.1em; margin-bottom: 10px; color: #37474f; font-weight: 600; }
  .oc-total { text-align: right; font-weight: 900; font-size: 1.6em; color: var(--primary); margin-bottom: 25px; }
  
  .oc-actions { display: flex; gap: 15px; flex-wrap: wrap; }
  .btn-act { flex: 1; padding: 16px; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; color: #fff; transition: 0.2s; font-size: 1em; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
  .btn-act:active { transform: scale(0.96); }
  .btn-accept { background: linear-gradient(135deg, #448aff 0%, #2962ff 100%); }
  .btn-ready { background: linear-gradient(135deg, #26c6da 0%, #00bcd4 100%); }
  .btn-cancel { background: linear-gradient(135deg, #ef5350 0%, #e57373 100%); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }

  .data-panel { background: #fff; border-radius: 25px; padding: 35px; box-shadow: var(--shadow); overflow-x: auto; margin-bottom: 40px; border: 1px solid #fff; }
  .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
  .panel-header h3 { margin: 0; color: #1a237e; font-size: 1.5em; font-weight: 800; }
  table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 650px; }
  th { text-align: left; color: #90a4ae; font-size: 0.85em; padding: 20px; border-bottom: 2px solid #eceff1; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  td { padding: 20px; border-bottom: 1px solid #f9f9f9; font-size: 1em; font-weight: 600; color: #546e7a; }
  .status-badge { padding: 8px 16px; border-radius: 30px; font-size: 0.85em; background: #e8f5e9; color: #2e7d32; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  
  .filter-bar { display: flex; gap: 15px; margin-bottom: 30px; }
  .date-in { padding: 14px; border: 1px solid #eee; border-radius: 15px; font-family: inherit; background: #fdfdfd; color: #333; outline: none; transition: 0.2s; box-shadow: inset 0 2px 5px rgba(0,0,0,0.02); }
  .date-in:focus { border-color: var(--primary); background: #fff; }

  .bank-card { background: #fff; padding: 35px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 40px; border-left: 8px solid #263238; position: relative; overflow: hidden; }
  .bank-title { font-size: 1.5em; font-weight: 800; margin-bottom: 30px; display: flex; align-items: center; gap: 15px; color: #263238; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
  .inp-group label { display: block; font-size: 0.9em; font-weight: 700; color: #78909c; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
  .inp-field { width: 100%; padding: 16px; border: 1px solid #eee; border-radius: 15px; font-size: 1.05em; background: #fdfdfd; transition: 0.2s; outline: none; }
  .inp-field:focus { border-color: #263238; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
  .btn-save { background: #263238; color: #fff; border: none; padding: 18px; border-radius: 15px; font-weight: 700; cursor: pointer; margin-top: 25px; width: 100%; font-size: 1.1em; transition: 0.2s; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
  .btn-save:hover { background: #000; transform: translateY(-2px); }
  
  .btn-withdraw { background: #00c853; font-size: 1em; padding: 16px; margin-top: 20px; width: 100%; border:none; border-radius:15px; color:#fff; font-weight:bold; cursor:pointer; box-shadow: 0 8px 20px rgba(0, 200, 83, 0.3); transition: 0.2s; }
  .btn-withdraw:hover { transform: translateY(-2px); filter: brightness(1.05); }
  .btn-withdraw:disabled { background: #cfd8dc; cursor: not-allowed; box-shadow: none; color: #90a4ae; transform: none; }
  .withdraw-note { font-size: 0.85em; color: #ff5252; margin-top: 10px; font-weight: 600; background: #ffebee; padding: 10px; border-radius: 10px; display: inline-block; }
  
  .btn-download { background: #ffa000; color: white; border: none; padding: 16px 28px; border-radius: 15px; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 12px; margin-top: 20px; box-shadow: 0 8px 20px rgba(255, 160, 0, 0.3); transition: 0.2s; }
  .btn-download:hover { transform: translateY(-2px); }

  .sound-btn { position: fixed; bottom: 35px; right: 35px; width: 60px; height: 60px; background: #263238; color: #fff; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 500; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: 0.2s; }
  .sound-btn:active { transform: scale(0.9); }
  .sound-btn:hover { transform: scale(1.05); }

  @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .oc-actions { flex-direction: column; } .login-card { padding: 40px 25px; } .topbar { padding: 10px 15px; } }
</style>
</head>
<body>

<div class="bg-logos" id="bgLogos"></div>

<audio id="orderSound" src="https://assets.mixkit.co/active_storage/sfx/933/933-preview.mp3" preload="auto"></audio>

<div id="loginScreen" class="login-overlay">
    <div class="login-card">
        <img src="icon.jpg" style="width:150px;height:150px;border-radius:35px;margin-bottom:30px;box-shadow:0 15px 30px rgba(0,0,0,0.1)">
        <h2 style="margin:0 0 10px 0;color:#1a237e;font-size:2em;font-weight:800" id="loginTitle">Espace Partenaire</h2>
        <p style="color:#78909c;margin-bottom:25px;font-weight:500;font-size:1.05em" id="loginSub">Entrez votre mot de passe</p>
        <input type="password" id="pinInput" class="pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button class="btn" onclick="checkPin()" id="loginBtn"><span class="emoji-anim">üîë</span> Connexion</button>
        <button class="btn-outline" onclick="showRegistrationOptions()" id="restaurantSpaceBtn"><span class="emoji-anim">üìù</span> <span id="regBtnText">S'inscrire</span></button>
        <button class="btn-install" id="installBtn"><span class="sticker-anim">üì≤</span> <span id="installBtnText">Installer l'application</span></button>
    </div>
</div>

<div class="topbar" id="dashHeader" style="display:none;">
    <div class="hamburger" id="menuBtn">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div class="shop-info-header">
        <div class="shop-title" id="shopName">Chargement...</div>
        <div class="shop-id" id="shopIdDisplay">...</div>
    </div>
</div>

<div class="menu-overlay" id="menuOverlay"></div>
<div class="menu" id="sideMenu">
    <div class="menu-header">
        <button class="close-btn" id="closeMenu">‚úï</button>
    </div>
    <nav>
        <a href="https://www.alexlivraison.shop" class="menu-link"><span class="emoji-anim">üè†</span> <span id="m-home">Accueil Site</span></a>
        <a href="https://www.alexlivraison.shop/commercants.html" class="menu-link" id="nav-back"><span class="emoji-anim">üè™</span> <span id="m-back">Nos Boutiques</span></a>
        <a href="#" class="menu-link" id="nav-myshop"><span class="emoji-anim">üìä</span> <span id="m-shop">Ma Boutique</span></a>
        <a href="https://www.alexlivraison.shop/commercants.html" class="menu-link" id="nav-settings"><span class="emoji-anim">üìù</span> <span id="m-settings">S'inscrire</span></a>
        <a href="https://wa.me/33677171188" target="_blank" class="menu-link"><span class="emoji-anim">üéß</span> <span id="m-contact">Support</span></a>
        <button onclick="location.reload()" class="menu-link" style="background:none;border:none;width:100%;text-align:left;color:#ff5252"><span class="emoji-anim">üîì</span> <span id="m-logout">D√©connexion</span></button>
        
        <div class="lang-section">
             <button onclick="changeLanguage('fr')" class="menu-link" style="background:none;border:none;width:100%;text-align:left;color:#78909c"><span class="emoji-anim">üá´üá∑</span> Fran√ßais</button>
             <button onclick="changeLanguage('en')" class="menu-link" style="background:none;border:none;width:100%;text-align:left;color:#78909c"><span class="emoji-anim">üá¨üáß</span> English</button>
        </div>
    </nav>
</div>

<div id="mainDash" class="dashboard">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label" id="l-bal">Solde Net</div>
            <div class="stat-val" id="balanceVal">0.00 ‚Ç¨</div>
            <div class="withdraw-note"><i class="fas fa-info-circle"></i> Retrait < 100‚Ç¨ : 1% frais.</div>
            <button id="withdrawBtn" class="btn-withdraw" onclick="requestPayout()" disabled>Retirer</button>
        </div>
        <div class="stat-card">
            <div class="stat-label" id="l-sales">Ventes (Net)</div>
            <div class="stat-val" id="salesVal">0.00 ‚Ç¨</div>
        </div>
        <div class="stat-card">
            <div class="stat-label" id="l-orders">Commandes</div>
            <div class="stat-val" id="ordersCount">0</div>
        </div>
    </div>

    <div class="live-section">
        <h2 class="live-title">
            <span class="emoji-anim">‚ö°</span> <span id="t-live">Commandes en Direct</span>
            <span style="font-size:0.5em;background:#2962ff;color:white;padding:5px 12px;border-radius:10px;animation:pulse 1.5s infinite;box-shadow:0 4px 10px rgba(41, 98, 255, 0.4);text-transform:uppercase;letter-spacing:1px">LIVE</span>
        </h2>
        <div id="liveGrid" class="orders-grid">
            <div style="grid-column:1/-1;text-align:center;padding:60px;color:#cfd8dc;background:#fff;border-radius:25px;box-shadow:var(--shadow);border:2px dashed #eceff1;font-weight:600;font-size:1.1em">En attente de commandes...</div>
        </div>
    </div>

    <div class="bank-card">
        <div class="bank-title"><i class="fas fa-file-contract"></i> <span id="t-docs">Documents L√©gaux</span></div>
        <a href="#" id="btn-download-contract" class="btn-download" style="display:none" target="_blank">
            <i class="fas fa-file-pdf"></i> T√©l√©charger ma Convention
        </a>
        <div id="no-contract-msg" style="color:#ff5252;display:none;font-size:0.95em;font-weight:600;background:#ffebee;padding:12px;border-radius:10px;margin-top:10px">Aucun contrat disponible. Contactez le support.</div>
    </div>

    <div class="bank-card">
        <div class="bank-title"><i class="fas fa-university"></i> <span id="t-bank">Coordonn√©es Bancaires (RIB)</span></div>
        <div class="form-grid">
            <div class="inp-group">
                <label>Titulaire du compte</label>
                <input type="text" id="bankOwner" class="inp-field">
            </div>
            <div class="inp-group">
                <label>Nom de la Banque</label>
                <input type="text" id="bankName" class="inp-field">
            </div>
            <div class="inp-group" style="grid-column: 1 / -1;">
                <label>IBAN</label>
                <input type="text" id="bankIban" class="inp-field" style="font-family:monospace;letter-spacing:2px;font-weight:600">
            </div>
            <div class="inp-group">
                <label>BIC / SWIFT</label>
                <input type="text" id="bankBic" class="inp-field">
            </div>
        </div>
        <button class="btn-save" onclick="saveBankInfo()" id="btn-save">Enregistrer les coordonn√©es</button>
    </div>

    <div class="data-panel">
        <div class="panel-header">
            <h3 id="t-history">Historique des Ventes</h3>
            <button class="btn" onclick="exportPDF()" style="font-size:0.9em;padding:12px 20px;width:auto;background:#ffa000;box-shadow:0 8px 20px rgba(255, 160, 0, 0.3)"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>
        
        <div class="filter-bar">
            <input type="date" id="dateFrom" class="date-in" onchange="filterData()">
            <input type="date" id="dateTo" class="date-in" onchange="filterData()">
        </div>

        <table id="ordersTable">
            <thead>
                <tr>
                    <th id="th-date">Date</th>
                    <th id="th-client">Client</th>
                    <th id="th-det">Produits</th>
                    <th>Net</th>
                    <th id="th-stat">Statut</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div class="sound-btn" onclick="testSound()">
    <i class="fas fa-volume-up"></i>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyAWagPwv5Skh_EHfdcnFTYeG-xltRM7yPc",authDomain:"alex-livraison.firebaseapp.com",projectId:"alex-livraison",storageBucket:"alex-livraison.firebasestorage.app",messagingSenderId:"937475497279",appId:"1:937475497279:web:62dc9eba8e77a5113ec78a"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const TRANSLATIONS = {
    fr: {
        loginT: "Espace Partenaire", loginS: "Entrez votre mot de passe", loginB: "Connexion", restaurantSpaceB: "S'inscrire", installApp: "Installer l'application",
        home: "Accueil Site", back: "Nos Boutiques", backRestaurant: "Mes Restaurants", shop: "Ma Boutique", shopRestaurant: "Mon Restaurant",
        settings: "S'inscrire", contact: "Support", logout: "D√©connexion",
        bal: "Solde Net", sales: "Ventes (Net)", orders: "Commandes",
        live: "Commandes en Direct", docs: "Documents L√©gaux", bank: "Coordonn√©es Bancaires (RIB)",
        save: "Enregistrer les coordonn√©es", hist: "Historique des Ventes",
        date: "Date", client: "Client", det: "Produits", stat: "Statut",
        accept: "Accepter", cancel: "Annuler", completed: "Pr√™t pour retrait / Envoi"
    },
    en: {
        loginT: "Partner Area", loginS: "Enter your password", loginB: "Login", restaurantSpaceB: "Register", installApp: "Install App",
        home: "Home Site", back: "Our Shops", backRestaurant: "Our Restaurants", shop: "My Shop", shopRestaurant: "My Restaurant",
        settings: "Register", contact: "Support", logout: "Logout",
        bal: "Net Balance", sales: "Sales (Net)", orders: "Orders",
        live: "Live Orders", docs: "Legal Documents", bank: "Bank Details (IBAN)",
        save: "Save Details", hist: "Sales History",
        date: "Date", client: "Client", det: "Items", stat: "Status",
        accept: "Accept", cancel: "Cancel", completed: "Ready for Pickup/Dispatch"
    }
};
let CUR_LANG = 'fr';

const menu = document.getElementById('sideMenu');
const overlay = document.getElementById('menuOverlay');
const menuBtn = document.getElementById('menuBtn');
const closeBtn = document.getElementById('closeMenu');

function toggleMenu(){
    menu.classList.toggle('open');
    overlay.classList.toggle('show');
}
menuBtn.onclick = toggleMenu;
closeBtn.onclick = toggleMenu;
overlay.onclick = toggleMenu;

let CURRENT_SHOP = null;
let ALL_ORDERS = [];
let CURRENT_BALANCE = 0;
let LIVE_UNSUBSCRIBE = null;
let deferredPrompt;

function changeLanguage(lang) {
    CUR_LANG = lang;
    const t = TRANSLATIONS[lang];
    document.getElementById('loginTitle').innerText = t.loginT;
    document.getElementById('loginSub').innerText = t.loginS;
    document.getElementById('loginBtn').innerHTML = `<span class="emoji-anim">üîë</span> ${t.loginB}`;
    document.getElementById('regBtnText').innerText = t.restaurantSpaceB;
    document.getElementById('installBtnText').innerText = t.installApp;
    document.getElementById('m-home').innerText = t.home;
    
    // Dynamic menu text based on partner category
    const isRestaurant = CURRENT_SHOP && CURRENT_SHOP.category === 'restaurants';
    document.getElementById('m-back').innerText = isRestaurant ? t.backRestaurant : t.back;
    document.getElementById('m-shop').innerText = isRestaurant ? t.shopRestaurant : t.shop;
    
    document.getElementById('m-settings').innerText = t.settings;
    document.getElementById('m-contact').innerText = t.contact;
    document.getElementById('m-logout').innerText = t.logout;
    
    document.getElementById('l-bal').innerText = t.bal;
    document.getElementById('l-sales').innerText = t.sales;
    document.getElementById('l-orders').innerText = t.orders;
    document.getElementById('t-live').innerText = t.live;
    document.getElementById('t-docs').innerText = t.docs;
    document.getElementById('t-bank').innerText = t.bank;
    document.getElementById('btn-save').innerText = t.save;
    document.getElementById('t-history').innerText = t.hist;
    
    document.getElementById('th-date').innerText = t.date;
    document.getElementById('th-client').innerText = t.client;
    document.getElementById('th-det').innerText = t.det;
    document.getElementById('th-stat').innerText = t.stat;
    toggleMenu();
}

function showRegistrationOptions() {
    const categories = [
        { name: 'Restaurants', url: 'https://www.alexlivraison.shop/form-restaurants.html' },
        { name: 'Supermarch√©s', url: 'https://www.alexlivraison.shop/form-supermarches.html' },
        { name: 'Boulangeries', url: 'https://www.alexlivraison.shop/form-boulangeries.html' },
        { name: 'Pharmacies', url: 'https://www.alexlivraison.shop/form-pharmacies.html' },
        { name: 'High-Tech', url: 'https://www.alexlivraison.shop/form-hightech.html' },
        { name: 'Occasions', url: 'https://www.alexlivraison.shop/form-occasions.html' },
        { name: 'Autres...', url: 'https://www.alexlivraison.shop/commercants.html' }
    ];
    
    let message = "Choisissez votre cat√©gorie de commerce :\n\n";
    categories.forEach((cat, i) => {
        message += `${i + 1}. ${cat.name}\n`;
    });
    message += "\nS√©lectionnez le num√©ro (1-7) :";
    
    const choice = prompt(message);
    const index = parseInt(choice) - 1;
    
    if (index >= 0 && index < categories.length) {
        window.location.href = categories[index].url;
    }
}

async function checkPin(){
    const pin = document.getElementById('pinInput').value;
    if(!pin) return;
    try {
        const snap = await db.collection('shops').where('pin', '==', pin).get();
        if(snap.empty) return alert("Mot de passe incorrect");
        
        CURRENT_SHOP = snap.docs[0].data();
        document.getElementById('loginScreen').style.display = 'none';
        
        document.getElementById('mainDash').style.display = 'block';
        document.getElementById('dashHeader').style.display = 'flex';
        
        document.getElementById('shopName').innerText = CURRENT_SHOP.name;
        document.getElementById('shopIdDisplay').innerText = CURRENT_SHOP.shopId;
        
        // Update menu texts and links based on category
        const isRestaurant = CURRENT_SHOP.category === 'restaurants';
        const currentLang = document.documentElement.lang || 'fr';
        const t = TRANSLATIONS[currentLang];
        console.log('üîß Menu Update: isRestaurant=', isRestaurant, 'category=', CURRENT_SHOP.category);
        console.log('üîß Texts: back="' + (isRestaurant ? t.backRestaurant : t.back) + '" shop="' + (isRestaurant ? t.shopRestaurant : t.shop) + '"');
        document.getElementById('m-back').innerText = isRestaurant ? t.backRestaurant : t.back;
        document.getElementById('m-shop').innerText = isRestaurant ? t.shopRestaurant : t.shop;
        
        // Update all menu links based on category
        const categoryUrls = {
            'restaurants': {
                list: 'https://www.alexlivraison.shop/restaurants.html',
                register: 'https://www.alexlivraison.shop/form-restaurants.html'
            },
            'default': {
                list: 'https://www.alexlivraison.shop/commercants.html',
                register: 'https://www.alexlivraison.shop/commercants.html'
            }
        };
        const urls = categoryUrls[CURRENT_SHOP.category] || categoryUrls.default;
        document.getElementById('nav-back').href = urls.list;
        document.getElementById('nav-settings').href = urls.register;
        
        // Show sound button after login
        const soundBtn = document.querySelector('.sound-btn');
        if(soundBtn) soundBtn.style.display = 'flex';
        
        // Dynamic shop link based on category
        const categoryLinks = {
            'hightech': 'shop-hightech.html',
            'occasions': 'shop-occasions.html',
            'restaurants': 'shop-restaurants.html'
        };
        const shopPage = categoryLinks[CURRENT_SHOP.category] || 'shop-hightech.html';
        document.getElementById('nav-myshop').href = `https://www.alexlivraison.shop/${shopPage}?id=${CURRENT_SHOP.shopId}&from=dashboard`;
        
        if(CURRENT_SHOP.contractUrl) {
            document.getElementById('btn-download-contract').href = CURRENT_SHOP.contractUrl;
            document.getElementById('btn-download-contract').style.display = 'inline-flex';
        } else {
            document.getElementById('no-contract-msg').style.display = 'block';
        }

        loadBankInfo();
        loadOrders();
        startLiveListener();
        testSound();
    } catch(e) { alert("Erreur connexion"); }
}

function testSound() {
    const audio = document.getElementById('orderSound');
    audio.play().catch(e => console.log("Audio require interaction"));
}

function startLiveListener() {
    console.log('üîä Starting live listener for shop:', CURRENT_SHOP.shopId);
    if(LIVE_UNSUBSCRIBE) LIVE_UNSUBSCRIBE();
    LIVE_UNSUBSCRIBE = db.collection('orders')
        .where('shopId', '==', CURRENT_SHOP.shopId)
        // ‚úÖ REMOVED status filter - show ALL orders, filter on client side!
        // ‚úÖ REMOVED .orderBy - requires Firestore index!
        .onSnapshot(snap => {
            console.log('üì¶ Snapshot received! Total orders:', snap.size);
            const grid = document.getElementById('liveGrid');
            grid.innerHTML = '';
            
            // ‚úÖ Filter on client: exclude only cancelled and delivered
            const activeOrders = [];
            snap.forEach(doc => {
                const data = doc.data();
                console.log('üìÑ Order:', doc.id, 'Status:', data.status);
                if(data.status !== 'cancelled' && data.status !== 'delivered') {
                    activeOrders.push({ id: doc.id, data: data });
                }
            });
            
            console.log('‚úÖ Active orders after filter:', activeOrders.length);
            
            if(activeOrders.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:50px;color:#b0bec5;background:#fff;border-radius:20px;box-shadow:var(--shadow);border:1px dashed #cfd8dc">Aucune commande active en ce moment</div>';
                return;
            }
            
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    const now = new Date();
                    const orderDate = data.createdAt ? data.createdAt.toDate() : new Date();
                    // ‚úÖ Sound for new orders
                    if((now - orderDate)/60000 < 5 && data.status !== 'cancelled' && data.status !== 'delivered') {
                        console.log('üîî Playing sound for new order');
                        document.getElementById('orderSound').play().catch(e => console.log('Audio error:', e));
                    }
                }
            });
            
            // ‚úÖ Client-side sorting
            activeOrders.sort((a, b) => {
                const timeA = a.data.createdAt ? a.data.createdAt.toMillis() : 0;
                const timeB = b.data.createdAt ? b.data.createdAt.toMillis() : 0;
                return timeB - timeA;
            });
            
            activeOrders.forEach(order => renderOrderCard(order.id, order.data, grid));
        }, error => {
            console.error('‚ùå Firestore error:', error);
        });
}

function renderOrderCard(id, data, container) {
    let statusColorClass = '';
    let actionsHtml = '';
    let statusText = '';
    const t = TRANSLATIONS[CUR_LANG];
    
    console.log('üé® Rendering card for order:', id, 'Status:', data.status);
    
    // ‚úÖ Handle ALL order statuses
    if(data.status === 'pending_payment') {
        statusColorClass = 'oc-new';
        statusText = 'PAIEMENT EN COURS üí≥';
        actionsHtml = `<div style="width:100%;text-align:center;color:#ff6f00;font-weight:bold;padding:10px;background:#fff3e0;border-radius:8px">En attente du paiement client...</div>`;
    } else if(data.status === 'pending' || data.status === 'paid') {
        statusColorClass = 'oc-new';
        statusText = 'NOUVEAU ‚ö°';
        actionsHtml = `
            <button class="btn-act btn-accept" onclick="updateStatus('${id}', 'accepted')"><i class="fas fa-check"></i> ${t.accept}</button>
            <button class="btn-act btn-cancel" onclick="updateStatus('${id}', 'cancelled')"><i class="fas fa-times"></i> ${t.cancel}</button>
        `;
    } else if(data.status === 'accepted' || data.status === 'cooking') {
        statusColorClass = 'oc-cooking';
        statusText = 'EN PR√âPARATION üõ†Ô∏è';
        actionsHtml = `<button class="btn-act btn-ready" onclick="updateStatus('${id}', 'ready_for_pickup')"><i class="fas fa-box-open"></i> ${t.completed}</button>`;
    } else if(data.status === 'ready_for_pickup') {
        statusColorClass = 'oc-ready';
        statusText = 'EN ATTENTE COURSIER üõµ';
        actionsHtml = `<div style="width:100%;text-align:center;color:#2e7d32;font-weight:bold;padding:10px;background:#e8f5e9;border-radius:8px">En attente de prise en charge...</div>`;
    }

    const itemsHtml = data.items.map(i => `
        <div class="oc-item">
            <span class="oc-item-name">${i.qty}x ${i.name}</span>
            <span>${(i.displayTotal || 0).toFixed(2)}‚Ç¨</span>
        </div>
        ${i.options && i.options.length ? `<div style="font-size:0.9em;color:#90a4ae;margin-left:10px;margin-bottom:5px">Opts: ${i.options.join(', ')}</div>` : ''}
    `).join('');

    const card = document.createElement('div');
    card.className = `order-card ${statusColorClass}`;
    card.innerHTML = `
        <div class="oc-header">
            <span class="oc-id">#${id.substr(0,8)}</span>
            <span class="oc-time">${data.createdAt ? new Date(data.createdAt.seconds*1000).toLocaleTimeString().substr(0,5) : '--:--'}</span>
        </div>
        <div style="font-weight:900;color:#2962ff;margin-bottom:12px;font-size:1.1em">${statusText}</div>
        <div class="oc-client">${data.customer.name}</div>
        <div class="oc-phone"><i class="fas fa-phone"></i> ${data.customer.phone}</div>
        <div class="oc-items">${itemsHtml}</div>
        <div class="oc-total">Total: ${data.totalPrice} ‚Ç¨</div>
        <div class="oc-note" style="font-size:0.9em;color:#546e7a;margin-bottom:15px;background:#f5f7fa;padding:10px;border-radius:10px;line-height:1.4">
            Mode: <strong>${data.deliveryType}</strong> | Paiement: <strong>${data.paymentMethod === 'card' ? 'CB (Pay√©)' : 'Esp√®ces'}</strong>
        </div>
        <div class="oc-actions">${actionsHtml}</div>
    `;
    container.appendChild(card);
}

function updateStatus(id, status) {
    if(status === 'cancelled' && !confirm("√ätes-vous s√ªr d'annuler cette commande ?")) return;
    db.collection('orders').doc(id).update({
        status: status,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });
}

function loadBankInfo() {
    if(CURRENT_SHOP.bankDetails) {
        document.getElementById('bankOwner').value = CURRENT_SHOP.bankDetails.owner || '';
        document.getElementById('bankName').value = CURRENT_SHOP.bankDetails.bankName || '';
        document.getElementById('bankIban').value = CURRENT_SHOP.bankDetails.iban || '';
        document.getElementById('bankBic').value = CURRENT_SHOP.bankDetails.bic || '';
        checkWithdrawEligibility();
    }
}

async function saveBankInfo() {
    const details = {
        owner: document.getElementById('bankOwner').value,
        bankName: document.getElementById('bankName').value,
        iban: document.getElementById('bankIban').value,
        bic: document.getElementById('bankBic').value
    };
    if(!details.iban || !details.owner) return alert("IBAN et Titulaire obligatoires.");
    try {
        await db.collection('shops').doc(CURRENT_SHOP.shopId).update({ bankDetails: details });
        CURRENT_SHOP.bankDetails = details;
        alert("Coordonn√©es enregistr√©es !");
        checkWithdrawEligibility();
    } catch(e) { alert("Erreur sauvegarde: " + e.message); }
}

function checkWithdrawEligibility() {
    const btn = document.getElementById('withdrawBtn');
    const hasBank = CURRENT_SHOP.bankDetails && CURRENT_SHOP.bankDetails.iban;
    const hasMoney = CURRENT_BALANCE > 0;
    btn.disabled = !(hasBank && hasMoney);
}

async function requestPayout() {
    if(CURRENT_BALANCE <= 0) return alert("Solde insuffisant.");
    let finalAmount = CURRENT_BALANCE;
    let fee = 0;
    let confirmMsg = `Confirmer la demande de virement de ${CURRENT_BALANCE.toFixed(2)} ‚Ç¨ ?`;
    if(CURRENT_BALANCE < 100) {
        fee = CURRENT_BALANCE * 0.01;
        finalAmount = CURRENT_BALANCE - fee;
        confirmMsg = `‚ö†Ô∏è ATTENTION : Solde < 100‚Ç¨.\nCommission 1% (${fee.toFixed(2)}‚Ç¨).\nNet √† recevoir : ${finalAmount.toFixed(2)} ‚Ç¨\nConfirmer ?`;
    }
    if(!confirm(confirmMsg)) return;
    const btn = document.getElementById('withdrawBtn');
    btn.disabled = true;
    btn.innerText = "Traitement...";
    try {
        await db.collection('payout_requests').add({
            shopId: CURRENT_SHOP.shopId,
            shopName: CURRENT_SHOP.name,
            totalBalance: CURRENT_BALANCE,
            feeApplied: fee,
            netAmount: finalAmount,
            bankDetails: CURRENT_SHOP.bankDetails,
            status: 'pending',
            requestedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Demande envoy√©e avec succ√®s ! Virement sous 24h.");
        btn.innerText = "Demande envoy√©e";
    } catch(e) {
        alert("Erreur: " + e.message);
        btn.disabled = false;
        btn.innerText = "Retirer";
    }
}

function loadOrders(){
    db.collection('orders')
      .where('shopId', '==', CURRENT_SHOP.shopId)
      // ‚úÖ REMOVED .orderBy - requires index!
      .onSnapshot(snap => {
          ALL_ORDERS = [];
          let totalNet = 0;
          let count = 0;
          snap.forEach(doc => {
              const d = doc.data();
              if(d.status !== 'cancelled') {
                  ALL_ORDERS.push(d);
                  totalNet += parseFloat(d.restaurantNet || 0);
                  count++;
              }
          });
          // ‚úÖ Sort on client
          ALL_ORDERS.sort((a, b) => {
              const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
              const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
              return timeB - timeA;
          });
          CURRENT_BALANCE = totalNet; 
          document.getElementById('salesVal').innerText = totalNet.toFixed(2) + " ‚Ç¨";
          document.getElementById('balanceVal').innerText = totalNet.toFixed(2) + " ‚Ç¨";
          document.getElementById('ordersCount').innerText = count;
          checkWithdrawEligibility();
          renderTable(ALL_ORDERS);
      });
}

function renderTable(data){
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    data.forEach(o => {
        const date = o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleString('fr-FR') : '-';
        let itemsStr = o.items.map(i => `${i.qty}x ${i.name}`).join(', ');
        if(itemsStr.length > 40) itemsStr = itemsStr.substring(0, 40) + '...';
        const row = `
        <tr>
            <td>${date}</td>
            <td>${o.customer.name}<br><small style="color:#78909c">${o.customer.phone}</small></td>
            <td>${itemsStr}</td>
            <td style="font-weight:bold;color:#00c853">${o.restaurantNet} ‚Ç¨</td>
            <td><span class="status-badge" style="background:${getStatusColor(o.status)}">${o.status}</span></td>
        </tr>`;
        tbody.innerHTML += row;
    });
}

function getStatusColor(s) {
    if(s==='pending') return '#e3f2fd;color:#1e88e5';
    if(s==='paid') return '#e0f7fa;color:#00acc1';
    if(s==='delivered') return '#263238;color:white';
    return '#e8f5e9;color:#2e7d32';
}

function filterData(){
    const from = document.getElementById('dateFrom').value;
    const to = document.getElementById('dateTo').value;
    if(!from && !to) return renderTable(ALL_ORDERS);
    const filtered = ALL_ORDERS.filter(o => {
        if(!o.createdAt) return false;
        const d = new Date(o.createdAt.seconds * 1000).toISOString().split('T')[0];
        if(from && d < from) return false;
        if(to && d > to) return false;
        return true;
    });
    renderTable(filtered);
}

function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const dFrom = document.getElementById('dateFrom').value;
    const dTo = document.getElementById('dateTo').value;
    
    doc.setFontSize(18);
    doc.text(`Rapport Financier - ${CURRENT_SHOP.name}`, 14, 20);
    doc.setFontSize(10);
    doc.text(`P√©riode: ${dFrom || 'D√©but'} au ${dTo || 'Aujourd\'hui'}`, 14, 30);
    
    let filtered = ALL_ORDERS;
    if(dFrom || dTo) {
        filtered = ALL_ORDERS.filter(o => {
            const d = new Date(o.createdAt.seconds * 1000).toISOString().split('T')[0];
            if(dFrom && d < dFrom) return false;
            if(dTo && d > dTo) return false;
            return true;
        });
    }

    const rows = filtered.map(o => [
        o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleString('fr-FR') : '-',
        o.customer.name + '\n' + o.customer.phone,
        o.items.map(i => `${i.qty}x ${i.name}`).join('\n'),
        o.restaurantNet + ' ‚Ç¨',
        o.status
    ]);
    
    doc.autoTable({
        head: [['Date', 'Client', 'Produits', 'Net', 'Statut']],
        body: rows,
        startY: 35,
        theme: 'grid',
        styles: { fontSize: 8 },
        columnStyles: { 2: { cellWidth: 70 } }
    });
    doc.save(`Rapport_${CURRENT_SHOP.shopId}.pdf`);
}

// Initialize floating background logos
function initFloatingLogos() {
    const container = document.getElementById('bgLogos');
    if(!container) return;
    container.innerHTML = ''; // Clear existing
    for(let i = 0; i < 8; i++) {
        const logo = document.createElement('img');
        logo.src = 'icon.jpg';
        logo.className = 'floating-logo';
        logo.style.left = Math.random() * 100 + '%';
        logo.style.animationDuration = (15 + Math.random() * 15) + 's';
        logo.style.animationDelay = -(Math.random() * 10) + 's';
        container.appendChild(logo);
    }
}

// Initialize on page load
initFloatingLogos();

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw-partner.js').catch(e => console.log('SW registration failed:', e));
    });
}

const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'flex';
});

installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        deferredPrompt = null;
        if(outcome === 'accepted') {
            installBtn.style.display = 'none';
        }
    }
});
</script>
</body>
</html> 
